package com.example.turismAPI;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.*;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.*;

@SpringBootApplication
@RestController
@RequestMapping("/api")
public class TurismApiApplication {

	private static String lastCounty = "unknown"; // Èšine minte judeÈ›ul ales de utilizator

	public static void main(String[] args) {
		SpringApplication.run(TurismApiApplication.class, args);
	}

	// ğŸ”¹ ÃncarcÄƒ datele dintr-un fiÈ™ier JSON
	private static <T> T loadJsonData(String fileName, TypeReference<T> typeReference) {
		String filePath = "src/main/resources/data/" + fileName + ".json";
		System.out.println("ğŸ“‚ Ãncerc sÄƒ Ã®ncarc fiÈ™ierul de la: " + filePath);

		File file = new File(filePath);
		if (!file.exists()) {
			System.out.println("âŒ FiÈ™ierul JSON NU EXISTÄ‚ la: " + file.getAbsolutePath());
			return null;
		}

		try (InputStream inputStream = new FileInputStream(file)) {
			ObjectMapper objectMapper = new ObjectMapper();
			return objectMapper.readValue(inputStream, typeReference);
		} catch (IOException e) {
			System.out.println("âŒ Eroare la citirea fiÈ™ierului JSON: " + e.getMessage());
			return null;
		}
	}

	// ğŸ”¹ Endpoint pentru Ã®ntrebÄƒri Ã®n limbaj natural
	@GetMapping("/ask")
	public Map<String, Object> askNaturalQuestion(@RequestParam String question) {
		Map<String, Object> response = new HashMap<>();
		String lowerQuestion = question.toLowerCase();

		// DetectÄƒm tipul Ã®ntrebÄƒrii
		String queryType = detectQueryType(lowerQuestion);
		if (queryType == null) {
			response.put("error", "Ãntrebare necunoscutÄƒ. FoloseÈ™te cuvinte ca 'cazare', 'trasee', 'restaurante', 'transport'.");
			return response;
		}

		// Extragem judeÈ›ul
		String county = extractCounty(lowerQuestion);
		if ("unknown".equals(county)) {
			response.put("error", "Nu am putut identifica judeÈ›ul.");
			return response;
		}

		// SalvÄƒm judeÈ›ul pentru Ã®ntrebÄƒrile urmÄƒtoare
		lastCounty = county;

		// RÄƒspundem Ã®n funcÈ›ie de tipul Ã®ntrebÄƒrii
		switch (queryType) {
			case "accommodation":
				response.put("accommodation", getAccommodation(county));
				break;
			case "trails":
				response.put("trails", getTrails(county));
				break;
			case "restaurants":
				response.put("restaurants", getRestaurants(county));
				break;
			case "transport":
				response.put("transport", getTransport(county));
				break;
			case "city_info":
				response.put("city_info", getCityInfo(county));
				break;
		}

		return response;
	}

	// ğŸ”¹ DetecteazÄƒ judeÈ›ul menÈ›ionat Ã®n Ã®ntrebare
	private String extractCounty(String question) {
		List<Map<String, Object>> citiesData = loadJsonData("cities", new TypeReference<List<Map<String, Object>>>() {});
		if (citiesData == null) return lastCounty; // DacÄƒ nu gÄƒsim nimic, returnÄƒm judeÈ›ul salvat anterior

		for (Map<String, Object> city : citiesData) {
			String cityName = city.get("name").toString().toLowerCase();
			String countyName = city.get("county").toString();
			if (question.contains(cityName)) {
				System.out.println("ğŸ™ OraÈ™ detectat: " + city.get("name") + " (JudeÈ›: " + countyName + ")");
				return countyName;
			}
		}

		return lastCounty;
	}

	// ğŸ”¹ DetecteazÄƒ tipul Ã®ntrebÄƒrii
	private String detectQueryType(String question) {
		if (question.contains("cazare") || question.contains("hotel")) return "accommodation";
		if (question.contains("traseu") || question.contains("trasee")) return "trails";
		if (question.contains("restaurant")) return "restaurants";
		if (question.contains("transport")) return "transport";
		if (question.contains("informaÈ›ii despre") || question.contains("despre")) return "city_info";
		return null;
	}

	// ğŸ”¹ ObÈ›ine cazare pentru un judeÈ› (CORECTAT âœ…)
	private List<Map<String, Object>> getAccommodation(String county) {
		List<Map<String, Object>> accommodations = loadJsonData("accommodation", new TypeReference<List<Map<String, Object>>>() {});

		if (accommodations == null) {
			System.out.println("âŒ Eroare: Nu s-au putut Ã®ncÄƒrca datele despre cazare.");
			return new ArrayList<>();
		}

		List<Map<String, Object>> filteredList = new ArrayList<>();
		for (Map<String, Object> hotel : accommodations) {
			if (hotel.get("county") != null && hotel.get("county").equals(county)) {
				filteredList.add(hotel);
			}
		}

		return filteredList;
	}

	// ğŸ”¹ ObÈ›ine restaurante pentru un judeÈ› (CORECTAT âœ…)
	private List<Map<String, Object>> getRestaurants(String county) {
		Map<String, Object> restaurantsWrapper = loadJsonData("restaurants", new TypeReference<Map<String, Object>>() {});

		if (restaurantsWrapper == null || !restaurantsWrapper.containsKey("restaurants")) {
			System.out.println("âŒ Eroare la Ã®ncÄƒrcarea `restaurants.json`: nu conÈ›ine cheia 'restaurants'.");
			return new ArrayList<>();
		}

		Map<String, List<Map<String, Object>>> restaurantsData = (Map<String, List<Map<String, Object>>>) restaurantsWrapper.get("restaurants");
		return restaurantsData.getOrDefault(county, new ArrayList<>());
	}

	// ğŸ”¹ ObÈ›ine transport pentru un judeÈ›
	private List<Map<String, Object>> getTransport(String county) {
		List<Map<String, Object>> transport = loadJsonData("transport", new TypeReference<List<Map<String, Object>>>() {});
		return filterByCounty(transport, county);
	}

	private List<Map<String, Object>> filterByCounty(List<Map<String, Object>> transport, String county) {
        return transport;
    }

	// ğŸ”¹ ObÈ›ine trasee pentru un judeÈ› (CORECTAT âœ…)
	private List<Map<String, Object>> getTrails(String county) {
		Map<String, Object> trailsWrapper = loadJsonData("trails", new TypeReference<Map<String, Object>>() {});

		if (trailsWrapper == null || !trailsWrapper.containsKey("trails")) {
			System.out.println("âŒ Eroare la Ã®ncÄƒrcarea `trails.json`: nu conÈ›ine cheia 'trails'.");
			return new ArrayList<>();
		}

		Map<String, List<Map<String, Object>>> trailsData = (Map<String, List<Map<String, Object>>>) trailsWrapper.get("trails");
		return trailsData.getOrDefault(county, new ArrayList<>());
	}

	// ğŸ”¹ ObÈ›ine informaÈ›ii despre un judeÈ›
	private Map<String, Object> getCityInfo(String county) {
		List<Map<String, Object>> citiesData = loadJsonData("cities", new TypeReference<List<Map<String, Object>>>() {});
		if (citiesData == null) return Map.of("error", "Nu s-au gÄƒsit informaÈ›ii.");

		for (Map<String, Object> city : citiesData) {
			if (city.get("county").equals(county)) {
				return city;
			}
		}

		return Map.of("error", "Nu s-au gÄƒsit informaÈ›ii pentru judeÈ›.");
	}
}
